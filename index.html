<!--‚¨áÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
      color: #333;
    }
    header, footer {
      background: #004d99;
      color: white;
      text-align: center;
      padding: 10px 20px;
    }
    nav {
      background: #007acc;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      padding: 15px 20px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background: #005b99;
    }
    main {
      padding: 20px;
    }
    .card {
      background: white;
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .flex-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .flex-item {
      flex: 1 1 200px;
      background: #e6f0ff;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      color: #333;
      transition: background-color 0.3s ease;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #005b99;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    .footer-info {
      font-size: 14px;
      margin-top: 5px;
    }
    #aqi-card {
      transition: background-color 0.3s ease;
      color: #000;
    }
    .card .value {
  font-size: 1.8rem;
  font-weight: bold;
  margin-top: 10px;
}

.card h3 {
  font-size: 1.1rem;
  margin-bottom: 8px;
  color: #333;
}

  </style>
</head>
<body>

  <header>
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
      <img src="images/logospu.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢" style="height: 60px;" />
  
      <div>
        <h1>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</h1>
        <p>"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô"</p>
      </div>
    </div>
  </header>

<nav>
  <a href="#">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  <a href="#">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</a>
  <a href="#">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</a>
  <a href="#">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</a>
  <a href="#">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</a>
  <a href="#">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
</nav>

<main>
  <section class="card">
    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px;">
      <div style="flex: 2; min-width: 280px;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
          <div class="flex-item" id="pm25-box">üå´Ô∏è PM2.5: <span id="pm25-value">--</span></div>
          <div class="flex-item" id="pm10-box">üå´Ô∏è PM10: <span id="pm10-value">--</span></div>
          <div class="flex-item">üå° Temp: <span id="temp-value">--</span></div>
          <div class="flex-item">üíß Humidity: <span id="humidity-value">--</span></div>
        </div>
        <div class="flex-item" style="margin-top: 15px;">üõë Status Pump: <span id="pump-status">--</span></div>
      </div>
      <div style="flex: 1; min-width: 220px;">
        <div id="aqi-card" style="background: #fff3cd; border-radius: 12px; padding: 15px; color: #333; font-family: 'Arial', sans-serif; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div id="aqi-value" style="font-size: 28px; font-weight: bold;">--</div>
              <div style="font-size: 14px;">US AQI</div>
            </div>
            <div>
              <div id="aqi-emoji" style="font-size: 36px;">üòê</div>
            </div>
          </div>
          <div id="aqi-level" style="font-size: 18px; margin: 8px 0;">--</div>
          <div style="margin-top: 10px;"><strong>PM2.5:</strong> <span id="aqi-pm">--</span> ¬µg/m¬≥</div>
          <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 14px;">
           
          </div>
        </div>
        
        <div style="text-align: right; margin-top: 10px;">
          <button onclick="openHistoryModal()">üìä ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
        </div>
      </div>
    </div>
    
  </section>
<!-- Summary -->
<!-- üîÑ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà -->
<section class="card">
  <h2 style="display: flex; align-items: center; gap: 10px; font-size: 1.5em; margin-bottom: 20px;">
    <span style="font-size: 1.4em;">üìä</span> 
    <span>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</span>
  </h2>

  <div class="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
    <div class="card"><h3>üå´ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ PM2.5</h3><div class="value">42 ¬µg/m¬≥</div></div>
    <div class="card"><h3>üå´ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ PM10</h3><div class="value">87 ¬µg/m¬≥</div></div>
    <div class="card"><h3>üå° ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><div class="value">30¬∞C</div></div>
    <div class="card"><h3>üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå</h3><div class="value">58%</div></div>
    <div class="card"><h3>üî∫ PM2.5 ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3><div class="value">78 ¬µg/m¬≥<br><small>(14:00 ‡∏ô.)</small></div></div>
    <div class="card"><h3>üîª PM2.5 ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</h3><div class="value">22 ¬µg/m¬≥<br><small>(04:00 ‡∏ô.)</small></div></div>
  </div>

  <div class="alert-bar" style="margin-top: 20px; padding: 10px; background: #f39c12; color: white; font-weight: bold; text-align: center; border-radius: 8px;">
    üü• ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô PM2.5: 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | PM10: 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  </div>

  <div class="footer" style="margin-top: 10px; text-align: center; font-size: 0.95rem; color: #555;">
    üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 26‚Äì27 ‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô 2025
  </div>
</section>


<!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
<section class="card chart">
<h2>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
<div>
  <button>1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</button>
  <button>6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</button>
  <button>24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</button>
  <button>7 ‡∏ß‡∏±‡∏ô</button>
</div>

<!-- üìÖ Date Picker -->
<div style="margin: 10px 0;">
  <label for="datePicker">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà üìÖ</label>
  <input type="date" id="datePicker" style="padding: 5px;" />
</div>

<!-- üì• ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î -->
<div style="margin-bottom: 10px;">
  <label for="downloadSelect"><strong>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</strong></label>
  <select id="downloadSelect" style="margin-left:10px; padding:5px;">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå --</option>
    <option value="csv">CSV üìä</option>
    <option value="pdf">PDF üìÑ</option>
  </select>
  
</div>

<canvas id="historyChart" style="max-height:300px; width:100%; background:white; border-radius:10px;"></canvas>
</section>



<!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå -->
<section class="card sensor-map">
<h2>üó∫ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h2>
<div style="height: 300px; border-radius: 10px; overflow: hidden;">
  <iframe
    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3875.790726255974!2d100.73778127485552!3d13.731116286658619!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x311d6705010b8dc5%3A0x69accc2f9c92dd0!2z4LmB4Lie4Lil4LmJ4LiZ4LiX4LmM4Lil4Liy4LiU4LiB4Lij4Liw4Lia4Lix4LiHIEFDUA!5e0!3m2!1sen!2sth!4v1745937370950!5m2!1sen!2sth"
    width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
  </iframe>
</div>
<div style="margin-top: 10px;">
  <a href="https://maps.app.goo.gl/JKTyXNTdbFWQvKTu7" target="_blank">
    <button>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps üìç</button>
  </a>
</div>
</section>

 <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á AQI -->
 <section class="aqi-status">
  <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô AQI</h2>
  <table>
    <thead>
      <tr>
        <th>AQI</th><th>PM2.5 (¬µg/m¬≥)</th><th>PM10 (¬µg/m¬≥)</th><th>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>0-25 üü¶</td><td>0-25</td><td>0-50</td><td>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡∏°‡∏≤‡∏Å</td></tr>
      <tr><td>26-50 üü©</td><td>26-37</td><td>51-80</td><td>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ</td></tr>
      <tr><td>51-100 üü®</td><td>38-50</td><td>81-120</td><td>‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</td></tr>
      <tr><td>101-200 üüß</td><td>51-90</td><td>121-180</td><td>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</td></tr>
      <tr><td>>200 üü•</td><td>91+</td><td>181+</td><td>‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</td></tr>
    </tbody>
  </table>
</section>
<!-- üîΩ Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
<div id="historyModal" style="
  display:none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 800px;
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.25);
  z-index: 9999;
  overflow-y: auto;
  max-height: 80vh;
">
  <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
  <div style="margin-bottom: 10px;">
    <label for="modalDatePicker">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: </label>
    <input type="date" id="modalDatePicker" />
  </div>
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>PM2.5</th><th>PM10</th><th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</th><th>‡∏õ‡∏±‡πä‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</th>
      </tr>
    </thead>
    <tbody id="historyTableBody">
      <!-- üßæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </tbody>
  </table>
  <div style="text-align: right; margin-top: 10px;">
    <button onclick="document.getElementById('historyModal').style.display='none'">‚ùå ‡∏õ‡∏¥‡∏î</button>
  </div>
</div>




</main>

<footer>
  <p>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2025</p>
  <div class="footer-info">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: ‡∏ô‡∏≤‡∏¢‡πÇ‡∏≠‡∏´‡πå‡∏° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤: ‡∏ú‡∏®.‡∏î‡∏£.‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";


  const firebaseConfig = {
    apiKey: "AIzaSyBVVhuktrqcs5rFNqVLDTvPAybwAJcF-Kc",
    authDomain: "air-quality-monitor-80a0c.firebaseapp.com",
    databaseURL: "https://air-quality-monitor-80a0c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "air-quality-monitor-80a0c",
    storageBucket: "air-quality-monitor-80a0c.appspot.com",
    messagingSenderId: "625949588545",
    appId: "1:625949588545:web:479e4636bf048615e19ac0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dataRef = ref(db, 'iot_data');

  onValue(dataRef, (snapshot) => {
    const dataAll = snapshot.val();
    if (!dataAll) return;

    let latestData = null;
    let latestTime = 0;

    Object.values(dataAll).forEach((entry) => {
      const ts = new Date(entry.timestamp).getTime();
      if (!isNaN(ts) && ts > latestTime) {
        latestTime = ts;
        latestData = entry;
      }
    });

    if (!latestData) return;

    const pm25 = parseFloat(latestData.pm25);
    const pm10 = parseFloat(latestData.pm10);

    displayValue('pm25-value', pm25, ' ¬µg/m¬≥');
    displayValue('pm10-value', pm10, ' ¬µg/m¬≥');
    displayValue('temp-value', latestData.temperature, '¬∞C');
    displayValue('humidity-value', latestData.humidity, '%');
    displayValue('pump-status', latestData.pump_status);

    const aqi = getAQILevelAndColor(pm25);
    displayValue('aqi-value', aqi.aqi);
    displayValue('aqi-level', aqi.level);
    displayValue('aqi-emoji', aqi.emoji);
    displayValue('aqi-pm', pm25.toFixed(1));

    const card = document.getElementById('aqi-card');
    if (card) card.style.backgroundColor = aqi.color;
  });

  function displayValue(id, value, unit = '') {
  const el = document.getElementById(id);
  if (el) el.innerText = value !== undefined ? value + unit : '--';

  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠ temp/humidity ‡πÅ‡∏•‡∏∞‡∏°‡∏µ mini ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢
  if (id === 'temp-value' && document.getElementById('temp-value-mini')) {
    document.getElementById('temp-value-mini').innerText = value !== undefined ? value : '--';
  }
  if (id === 'humidity-value' && document.getElementById('humidity-value-mini')) {
    document.getElementById('humidity-value-mini').innerText = value !== undefined ? value : '--';
  }
}



  function getAQILevelAndColor(pm25) {
    if (pm25 <= 25) return { aqi: 25, level: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', color: '#3f87ff', emoji: 'üòÉ' };
    if (pm25 <= 37) return { aqi: 40, level: '‡∏î‡∏µ', color: '#28a745', emoji: 'üôÇ' };
    if (pm25 <= 50) return { aqi: 65, level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', color: '#ffc107', emoji: 'üòê' };
    if (pm25 <= 90) return { aqi: 120, level: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', color: '#fd7e14', emoji: 'üò∑' };
    return { aqi: 180, level: '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', color: '#dc3545', emoji: 'ü§¢' };
  }
  function getPM25Background(value) {
    if (value <= 25) return '#cce5ff';
    if (value <= 37) return '#d4edda';
    if (value <= 50) return '#fff3cd';
    if (value <= 90) return '#ffe5b4';
    return '#f8d7da';
  }

  function getPM10Background(value) {
    if (value <= 50) return '#cce5ff';
    if (value <= 80) return '#d4edda';
    if (value <= 120) return '#fff3cd';
    if (value <= 180) return '#ffe5b4';
    return '#f8d7da';
  }

  // ----- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -----
  let historyChart;

  function createChart(labels, pm25Data, pm10Data) {
    const ctx = document.getElementById('historyChart').getContext('2d');
    if (historyChart) historyChart.destroy();

    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'PM2.5 (¬µg/m¬≥)',
            data: pm25Data,
            borderColor: '#ff6384',
            backgroundColor: 'rgba(255,99,132,0.1)',
            tension: 0.2
          },
          {
            label: 'PM10 (¬µg/m¬≥)',
            data: pm10Data,
            borderColor: '#36a2eb',
            backgroundColor: 'rgba(54,162,235,0.1)',
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: '‡πÄ‡∏ß‡∏•‡∏≤' } },
          y: { title: { display: true, text: '¬µg/m¬≥' } }
        }
      }
    });
  }

  function loadHistoryData(hours = 24) {
    const now = Date.now();
    const startTime = now - (hours * 60 * 60 * 1000);

    get(dataRef).then(snapshot => {
      const rawData = snapshot.val();
      const labels = [], pm25Data = [], pm10Data = [];

      Object.entries(rawData).forEach(([key, val]) => {
        const ts = new Date(val.timestamp).getTime();
        if (!isNaN(ts) && ts >= startTime) {
          const label = new Date(ts).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          labels.push(label);
          pm25Data.push(parseFloat(val.pm25));
          pm10Data.push(parseFloat(val.pm10));
        }
      });

      if (labels.length === 0) {
        labels.push("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        pm25Data.push(null);
        pm10Data.push(null);
      }

      createChart(labels, pm25Data, pm10Data);
    });
  }

  window.addEventListener('load', () => {
    loadHistoryData(24);
  });

  document.querySelectorAll('.chart button').forEach(btn => {
    btn.addEventListener('click', () => {
      const txt = btn.innerText;
      if (txt.includes('1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á')) loadHistoryData(1);
      else if (txt.includes('6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á')) loadHistoryData(6);
      else if (txt.includes('24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á')) loadHistoryData(24);
      else if (txt.includes('7 ‡∏ß‡∏±‡∏ô')) loadHistoryData(24 * 7);
    });
  });

  // üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü
document.getElementById('datePicker').addEventListener('change', (e) => {
  const selectedDate = new Date(e.target.value);
  if (isNaN(selectedDate.getTime())) return;

  const start = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
  const end = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();

  get(dataRef).then(snapshot => {
    const rawData = snapshot.val();
    const labels = [], pm25Data = [], pm10Data = [];

    Object.values(rawData).forEach(val => {
      const ts = new Date(val.timestamp).getTime();
      if (!isNaN(ts) && ts >= start && ts <= end) {
        labels.push(new Date(ts).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }));
        pm25Data.push(parseFloat(val.pm25));
        pm10Data.push(parseFloat(val.pm10));
      }
    });

    if (labels.length === 0) {
      labels.push("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      pm25Data.push(null);
      pm10Data.push(null);
    }

    createChart(labels, pm25Data, pm10Data);
  });
});

// üì• ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV/Excel
function handleDownload(type) {
  if (!historyChart) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");

  const labels = historyChart.data.labels;
  const pm25Data = historyChart.data.datasets[0].data;
  const pm10Data = historyChart.data.datasets[1].data;

  if (type === 'csv') {
    let csv = "‡πÄ‡∏ß‡∏•‡∏≤,PM2.5,PM10\n";
    for (let i = 0; i < labels.length; i++) {
      csv += `${labels[i]},${pm25Data[i] ?? ""},${pm10Data[i] ?? ""}\n`;
    }

    const BOM = "\uFEFF";
    const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "aqi_data.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  if (type === 'pdf') {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const margin = 10;
    let y = 15;

    const pageWidth = pdf.internal.pageSize.getWidth();

    pdf.setFont("THSarabun", "normal"); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ
    pdf.setFontSize(16);
    pdf.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á", pageWidth / 2, y, { align: "center" });
    y += 10;

    pdf.setFontSize(12);
    const today = new Date().toLocaleDateString('th-TH');
    pdf.text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${today}`, margin, y); y += 8;
    pdf.text("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï XYZ", margin, y); y += 10;

    pdf.setFontSize(14);
    pdf.text("1. ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°", margin, y); y += 8;
    pdf.setFontSize(12);
    pdf.text("- ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ PM2.5: 42 ¬µg/m¬≥", margin, y); y += 6;
    pdf.text("- ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ PM10: 87 ¬µg/m¬≥", margin, y); y += 6;
    pdf.text("- ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: 30¬∞C", margin, y); y += 6;
    pdf.text("- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: 58%", margin, y); y += 10;

    pdf.setFontSize(14);
    pdf.text("2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°", margin, y); y += 8;
    pdf.setFontSize(12);
    pdf.text("- PM2.5 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô", margin, y); y += 6;
    pdf.text("- PM10 ‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏•‡∏î‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô", margin, y); y += 10;

    // üîπ ‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å canvas
    html2canvas(document.getElementById('historyChart')).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = pageWidth - margin * 2;
      const imgHeight = imgWidth * (canvas.height / canvas.width);

      if (y + imgHeight > 280) {
        pdf.addPage();
        y = 15;
      }

      pdf.setFontSize(14);
      pdf.text("3. ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á", margin, y);
      y += 5;

      pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);
      y += imgHeight + 10;

      // üî∏ ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
      if (y > 250) {
        pdf.addPage();
        y = 15;
      }

      pdf.setFontSize(14);
      pdf.text("4. ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", margin, y); y += 8;
      pdf.setFontSize(12);
      pdf.text("- ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ PM2.5 ‡πÄ‡∏Å‡∏¥‡∏ô 50 ¬µg/m¬≥", margin, y); y += 6;
      pdf.text("- ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á", margin, y); y += 10;

      // üîö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      pdf.save("air_quality_report.pdf");
    });
  }

  document.getElementById("downloadSelect").value = "";
}


// üì• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleDownload
document.getElementById('downloadSelect').addEventListener('change', function () {
  const fileType = this.value;
  if (fileType) {
    handleDownload(fileType);
  }
});
window.openHistoryModal = function () {
  document.getElementById('historyModal').style.display = 'block';
  const today = new Date().toISOString().split("T")[0];
  document.getElementById('modalDatePicker').value = today;
  loadHistoryTable(today);
};


document.getElementById('modalDatePicker').addEventListener('change', function () {
  loadHistoryTable(this.value);
});

function loadHistoryTable(dateStr) {
  if (!dateStr) return;
  const selectedDate = new Date(dateStr);
  const start = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
  const end = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();

  get(dataRef).then(snapshot => {
    const data = snapshot.val();
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = "";

    const rows = [];

    Object.values(data).forEach(entry => {
      const ts = new Date(entry.timestamp).getTime();
      if (ts >= start && ts <= end) {
        rows.push(`
          <tr>
            <td>${new Date(ts).toLocaleTimeString('th-TH')}</td>
            <td>${entry.pm25 ?? '--'}</td>
            <td>${entry.pm10 ?? '--'}</td>
            <td>${entry.temperature ?? 'undefined'}</td>
            <td>${entry.humidity ?? 'undefined'}</td>
            <td>${entry.pump_status ?? '--'}</td>
            <td>${getAQILevel(entry.pm25)}</td>
          </tr>
        `);
      }
    });

    tbody.innerHTML = rows.length > 0 ? rows.join("") : `<tr><td colspan="7">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
  });
}

function getAQILevel(pm25) {
  const val = parseFloat(pm25);
  if (val <= 25) return '‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
  if (val <= 37) return '‡∏î‡∏µ';
  if (val <= 50) return '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
  if (val <= 90) return '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•';
  return '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢';
}


</script>

</body>
</html>
<!-- ‚¨ÜÔ∏è ‡∏à‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå -->
