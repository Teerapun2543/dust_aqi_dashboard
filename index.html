<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Arial', sans-serif; background: #f4f7fa; margin: 0; }
    header { background: #005bbb; color: white; padding: 1rem; text-align: center; }
    nav { background: #003d80; padding: 1rem; color: white; }
    nav a { color: white; margin-right: 1rem; text-decoration: none; }
    .container { padding: 2rem; }
    .card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .grid { display: flex; flex-wrap: wrap; gap: 1rem; }
    .grid .card { flex: 1; min-width: 200px; }
    #map { width: 80%; max-width: 600px; height: 300px; margin: 0 auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    canvas { width: 100% !important; height: 300px !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; font-size: 14px; }
    th { background: #e6f0ff; }

    /* Modal Style */
    #historyModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
    #historyModalContent { background:white; padding:20px; border-radius:8px; max-width:90%; max-height:90%; overflow:auto; position:relative; }
    #historyModalContent button { position:absolute; top:10px; right:10px; background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
  </style>
</head>

<body>
  <header>
    <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô - ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏™‡∏°‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</h1>
  </header>

  <nav>
    <a href="#realtime">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-Time</a>
    <a href="#chart">‡∏Å‡∏£‡∏≤‡∏ü</a>
    <a href="#history">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</a>
    <a href="#map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
  </nav>

  <div class="container">

    <!-- Section Realtime -->
    <section id="realtime" class="grid">
      <div class="card"><h3>‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á (PM2.5)</h3><div id="pmValue">--</div></div>
      <div class="card"><h3>‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á (PM10)</h3><div id="pm10Value">--</div></div>
      <div class="card"><h3>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h3><div id="tempValue">--</div></div>
      <div class="card"><h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</h3><div id="humValue">--</div></div>
      <div class="card"><h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°</h3><div id="pumpStatus">--</div></div>
      <div class="card"><h3>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h3><div id="dangerLevel">--</div></div>
    </section>

    <!-- Section Chart -->
    <section id="chart" class="card" style="border: 2px solid #ccc;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ</h3>
        <div style="display: flex; gap: 20px; align-items: center;">
          <div id="timeRange" style="font-size: 14px; color: #555;"></div> 
          <div id="currentTime" style="font-size: 14px; color: #555; border: 1px solid #ccc; padding: 5px 10px; border-radius: 6px;"></div> 
        </div>
      </div>
      <button onclick="downloadCSV()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</button>
      <button onclick="downloadPDF()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</button>
      <div style="display: flex; gap: 1rem; overflow-x: auto; margin-top: 1rem;">
        <div style="flex: 1; min-width: 400px;"><canvas id="pm25Chart"></canvas></div>
        <div style="flex: 1; min-width: 400px;"><canvas id="pm10Chart"></canvas></div>
        <div style="flex: 1; min-width: 400px;"><canvas id="tempChart"></canvas></div>
        <div style="flex: 1; min-width: 400px;"><canvas id="humChart"></canvas></div>
      </div>
    </section>

    <!-- Section History -->
    <section id="history" class="card">
      <h3>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
      <input type="date" id="startDate">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
      <input type="date" id="endDate">
      <br><br>
      <button onclick="showHistory()">üìÑ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
      <button onclick="downloadHistoryCSV()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (CSV)</button>
    </section>

    <!-- Section Map -->
    <section id="map" class="card">
      <h3>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
      <div id="map"></div>
    </section>

  </div>

  <!-- Modal Popup -->
  <div id="historyModal">
    <div id="historyModalContent">
      <button onclick="closeModal()">X</button>
      <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <div id="historyData"></div>
    </div>
  </div>

<script>
// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBVVhuktrqcs5rFNqVLDTvPAybwAJcF-Kc",
  authDomain: "air-quality-monitor-80a0c.firebaseapp.com",
  databaseURL: "https://air-quality-monitor-80a0c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "air-quality-monitor-80a0c",
  storageBucket: "air-quality-monitor-80a0c.appspot.com",
  messagingSenderId: "625949588545",
  appId: "1:625949588545:web:479e4636bf048615e19ac0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ‚úÖ Real-time Update
db.ref("iot_data").orderByKey().limitToLast(1).on("value", snapshot => {
  snapshot.forEach(child => {
    const data = child.val();
    document.getElementById("pmValue").textContent = data.pm25 + " ¬µg/m¬≥";
    document.getElementById("pm10Value").textContent = data.pm10 + " ¬µg/m¬≥";
    document.getElementById("tempValue").textContent = data.temperature + " ¬∞C";
    document.getElementById("humValue").textContent = data.humidity + " %";
    document.getElementById("pumpStatus").textContent = data.pump_status;
    document.getElementById("dangerLevel").textContent = data.air_status || "Unknown";
  });
});

// ‚úÖ Chart.js
const charts = {
  pm25: new Chart(document.getElementById('pm25Chart').getContext('2d'), createChartConfig("PM2.5", 'rgba(0,123,255,1)')),
  pm10: new Chart(document.getElementById('pm10Chart').getContext('2d'), createChartConfig("PM10", 'rgba(255,165,0,1)')),
  temp: new Chart(document.getElementById('tempChart').getContext('2d'), createChartConfig("Temperature (¬∞C)", 'rgba(255,99,132,1)')),
  hum: new Chart(document.getElementById('humChart').getContext('2d'), createChartConfig("Humidity (%)", 'rgba(75,192,192,1)')),
};

function createChartConfig(label, borderColor) {
  return {
    type: 'line',
    data: { labels: [], datasets: [{ label, data: [], backgroundColor: borderColor.replace('1)', '0.2)'), borderColor, borderWidth: 2, pointRadius: 0, fill: true, tension: 0.3 }] },
    options: {
      responsive: true,
      scales: {
        x: { type: 'time', time: { unit: 'minute', tooltipFormat: 'HH:mm', displayFormats: { minute: 'HH:mm' } }, title: { display: true, text: '‡πÄ‡∏ß‡∏•‡∏≤' }, ticks: { autoSkip: true, maxTicksLimit: 6 }},
        y: { beginAtZero: true, title: { display: true, text: label }}
      }
    }
  };
}

// ‚úÖ Update All Charts
function updateAllCharts() {
  db.ref("iot_data").orderByKey().limitToLast(5).once("value").then(snapshot => {
    const labels = [], pm25 = [], pm10 = [], temp = [], hum = [];
    snapshot.forEach(child => {
      const d = child.val();
      labels.push(new Date(d.timestamp || child.key));
      pm25.push(d.pm25);
      pm10.push(d.pm10);
      temp.push(d.temperature);
      hum.push(d.humidity);
    });
    charts.pm25.data.labels = labels; charts.pm25.data.datasets[0].data = pm25; charts.pm25.update();
    charts.pm10.data.labels = labels; charts.pm10.data.datasets[0].data = pm10; charts.pm10.update();
    charts.temp.data.labels = labels; charts.temp.data.datasets[0].data = temp; charts.temp.update();
    charts.hum.data.labels = labels; charts.hum.data.datasets[0].data = hum; charts.hum.update();

    if (labels.length > 0) {
      document.getElementById('timeRange').textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á: ${labels[0].toLocaleTimeString('th-TH')} - ${labels[labels.length-1].toLocaleTimeString('th-TH')}`;
    }
  });
}
updateAllCharts();

// ‚úÖ Show History Modal
function showHistory() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const historyDiv = document.getElementById('historyData');
  if (!startDate || !endDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }
  historyDiv.innerHTML = '';

  const startTimestamp = new Date(startDate).getTime();
  const endTimestamp = new Date(endDate).getTime() + 86400000 - 1;

  db.ref("iot_data").once("value").then(snapshot => {
    let table = `<table><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>PM2.5</th><th>PM10</th><th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</th><th>‡∏õ‡∏±‡πä‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</th></tr></thead><tbody>`;
    let found = false;
    snapshot.forEach(child => {
      const d = child.val();
      const timestamp = d.timestamp ? new Date(d.timestamp).getTime() : Number(child.key);
      if (timestamp >= startTimestamp && timestamp <= endTimestamp) {
        found = true;
        table += `<tr><td>${new Date(timestamp).toLocaleString('th-TH')}</td><td>${d.pm25}</td><td>${d.pm10}</td><td>${d.temperature}</td><td>${d.humidity}</td><td>${d.pump_status}</td><td>${d.air_status}</td></tr>`;
      }
    });
    table += '</tbody></table>';
    historyDiv.innerHTML = found ? table : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    document.getElementById('historyModal').style.display = 'flex';
  });
}
function closeModal() { document.getElementById('historyModal').style.display = 'none'; }

// ‚úÖ Current Time
function updateCurrentTime() {
  const now = new Date();
  document.getElementById('currentTime').textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}`;
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

// ‚úÖ Map
const map = L.map('map').setView([13.7311, 100.7403], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([13.7311, 100.7403]).addTo(map).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô').openPopup();

</script>

</body>
</html>
