<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: 'Arial', sans-serif; background: #f4f7fa; margin: 0; }
    header { background: #005bbb; color: white; padding: 1rem; text-align: center; }
    nav { background: #003d80; padding: 1rem; color: white; }
    nav a { color: white; margin-right: 1rem; text-decoration: none; }
    .container { padding: 2rem; }
    .card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .grid { display: flex; flex-wrap: wrap; gap: 1rem; }
    .grid .card { flex: 1; min-width: 200px; }
    #map { width: 100%; height: 300px; }
    button { margin-left: 1rem; }
    #chartContainer { width: 100%; overflow-x: auto; }
    canvas { width: 100% !important; height: 400px !important; }
  </style>
</head>
<body>
  <header>
    <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô - ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏™‡∏°‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</h1>
  </header>
  <nav>
    <a href="#realtime">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-Time</a>
    <a href="#chart">‡∏Å‡∏£‡∏≤‡∏ü</a>
    <a href="#history">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</a>
    <a href="#map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
  </nav>

  <div class="container">
    <section id="realtime" class="grid">
      <div class="card"><h3>‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á (PM2.5)</h3><div id="pmValue">--</div></div>
      <div class="card"><h3>‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á (PM10)</h3><div id="pm10Value">--</div></div>
      <div class="card"><h3>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h3><div id="tempValue">--</div></div>
      <div class="card"><h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</h3><div id="humValue">--</div></div>
      <div class="card"><h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°</h3><div id="pumpStatus">--</div></div>
      <div class="card"><h3>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h3><div id="dangerLevel">--</div></div>
    </section>
    <section id="chart" class="card" style="border: 2px solid #ccc;">
      <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô</h3>
      <label for="dustType">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô: </label>
      <select id="dustType" onchange="updateChart()">
        <option value="pm25" selected>PM2.5</option>
        <option value="pm10">PM10</option>
      </select>
      <button onclick="downloadCSV()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
      <div id="chartContainer">
        <canvas id="pmChart"></canvas>
      </div>
    </section>

    <section id="history" class="card">
      <h3>‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button onclick="fetchHistory()">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button onclick="downloadHistoryCSV()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
      <div id="historyData"></div>
    </section>
    

    <section id="map" class="card">
      <h3>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
      <div id="map"></div>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVVhuktrqcs5rFNqVLDTvPAybwAJcF-Kc",
      authDomain: "air-quality-monitor-80a0c.firebaseapp.com",
      databaseURL: "https://air-quality-monitor-80a0c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "air-quality-monitor-80a0c",
      storageBucket: "air-quality-monitor-80a0c.appspot.com",
      messagingSenderId: "625949588545",
      appId: "1:625949588545:web:479e4636bf048615e19ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("iot_data").orderByKey().limitToLast(1).on("value", snapshot => {
  snapshot.forEach(child => {
    const data = child.val();

    document.getElementById("pmValue").textContent = data.pm25 + " ¬µg/m¬≥";
    document.getElementById("pm10Value").textContent = data.pm10 + " ¬µg/m¬≥";
    document.getElementById("tempValue").textContent = data.temperature + " ¬∞C";
    document.getElementById("humValue").textContent = data.humidity + " %";
    document.getElementById("pumpStatus").textContent = data.pump_status;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ
    const dangerEl = document.getElementById("dangerLevel");
    const status = data.air_status || "Unknown";
    dangerEl.textContent = status;

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå style ‡∏Å‡πà‡∏≠‡∏ô
    dangerEl.style = "";

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    switch (status.toLowerCase()) {
      case "excellent":
        dangerEl.style.color = "blue";
        dangerEl.style.backgroundColor = "#e0f0ff";
        break;
      case "good":
        dangerEl.style.color = "green";
        dangerEl.style.backgroundColor = "#e0ffe0";
        break;
      case "moderate":
        dangerEl.style.color = "gold";
        dangerEl.style.backgroundColor = "#fffacc";
        break;
      case "unhealthy":
        dangerEl.style.color = "orange";
        dangerEl.style.backgroundColor = "#ffe9cc";
        break;
      case "very unhealthy":
        dangerEl.style.color = "red";
        dangerEl.style.backgroundColor = "#ffd6d6";
        break;
      default:
        dangerEl.style.color = "black";
        dangerEl.style.backgroundColor = "#f0f0f0";
        break;
    }

    // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô
    dangerEl.style.fontWeight = "bold";
    dangerEl.style.padding = "5px 10px";
    dangerEl.style.borderRadius = "6px";
    dangerEl.style.display = "inline-block";
    dangerEl.style.marginTop = "5px";
  });
});


    const ctx = document.getElementById('pmChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'PM2.5',
          data: [],
          backgroundColor: 'rgba(0, 123, 255, 0.2)',
          borderColor: 'rgba(0, 123, 255, 1)',
          borderWidth: 2,
          pointBackgroundColor: '#fff',
          pointBorderColor: 'rgba(0, 123, 255, 1)',
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 14 } } },
          tooltip: {
            callbacks: {
              title: function(tooltipItems) {
                return tooltipItems[0].label;
              }
            },
            backgroundColor: '#fff',
            borderColor: '#ccc',
            borderWidth: 1,
            titleColor: '#000',
            bodyColor: '#000'
          }
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤',
              font: { size: 14 }
            },
            ticks: {
              autoSkip: true,
              maxRotation: 45,
              minRotation: 30
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: '‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô (¬µg/m¬≥)',
              font: { size: 14 }
            },
            ticks: {
              stepSize: 10
            }
          }
        }
      }
    });

    function updateChart() {
      const type = document.getElementById("dustType").value;
      db.ref("iot_data").orderByKey().limitToLast(100).once("value").then(snapshot => {
        const labels = [], values = [];
        snapshot.forEach(child => {
          const data = child.val();
          const fullTimestamp = data.timestamp || child.key;
          labels.push(fullTimestamp);
          values.push(type === "pm10" ? data.pm10 : data.pm25);
        });

        chart.data.labels = labels;
        chart.data.datasets[0] = {
          label: type.toUpperCase(),
          data: values,
          backgroundColor: type === "pm10" ? 'rgba(255, 165, 0, 0.2)' : 'rgba(0, 123, 255, 0.2)',
          borderColor: type === "pm10" ? 'rgba(255, 165, 0, 1)' : 'rgba(0, 123, 255, 1)',
          borderWidth: 2,
          pointBackgroundColor: '#fff',
          pointBorderColor: type === "pm10" ? 'rgba(255, 165, 0, 1)' : 'rgba(0, 123, 255, 1)',
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          tension: 0.3
        };

        chart.update();
      });
    }

    function downloadCSV() {
      const type = document.getElementById("dustType").value;
      db.ref("iot_data").orderByKey().limitToLast(100).once("value").then(snapshot => {
        let csv = "Timestamp," + type.toUpperCase() + "\n";
        snapshot.forEach(child => {
          const data = child.val();
          const timestamp = data.timestamp || child.key;
          const value = type === "pm10" ? data.pm10 : data.pm25;
          csv += `${timestamp},${value}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `dust-${type}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    function downloadHistoryCSV() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const type = document.getElementById("dustType").value;

  if (!start || !end) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î");
    return;
  }

  db.ref("iot_data").orderByKey().once("value").then(snapshot => {
    let csv = "Timestamp," + type.toUpperCase() + "\n";

    snapshot.forEach(child => {
      const key = child.key;
      const datePart = key.split("_")[0]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      const data = child.val();

      if (datePart >= start && datePart <= end) {
        const timestamp = data.timestamp || key;
        const value = type === "pm10" ? data.pm10 : data.pm25;
        csv += `${timestamp},${value}\n`;
      }
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `history-${type}-${start}_to_${end}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
}



    const map = L.map('map').setView([13.731101956120513, 100.74035954845426], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.marker([13.731101956120513, 100.74035954845426]).addTo(map)
      .bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô')
      .openPopup();

    // Add historical data popup to the map
    function addPopupToMap(timestamp, pm25, pm10) {
      L.marker([13.731101956120513, 100.74035954845426]).addTo(map)
        .bindPopup(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${timestamp}<br>PM2.5: ${pm25} ¬µg/m¬≥<br>PM10: ${pm10} ¬µg/m¬≥`)
        .openPopup();
    }

    updateChart();
  </script>
</body>
</html>
